<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Linx-chat</title>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>

  <script type="text/javascript" src="/chat/socket.io/socket.io.js"></script>
  <style>
    input {
      width: 100%;
    }
  </style>
</head>

<body>
  <h1>Linx Chat</h1>
  <form name="form">
    <h2>Configuration</h2>
    <label for="server">Server:</label>
    <input type="text" id="server" placeholder="http://127.0.0.1:3003" value="http://localhost:3003">
    <br>
    <label for="token">Token:</label>
    <input type="text" id="token" value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjU5Y2JiMjAwYTA1ZTQyNDY5N2QzOWZjZCIsImlhdCI6MTUwNjUyOTM3NjM1NX0.E9r3ocij1a_2pPsxGQkgU1y_IVjlMxl71Nt51kb_Gsc">
    <br>    
    <label for="exchangeMatchId">Exchange Match ID:</label>
    <input type="text" id="exchangeMatchId" value="59cbc9cfa05e424697d39ff6">
    <br>
    <br>  
    <input type="button" value="Connect" onclick="connect()">    
    <input type="button" value="Join" onclick="setup()"> 
    <input type="button" value="Leave" onclick="leave()"> 
    <input type="button" value="Disconnect" onclick="disconnect()">
    <div id="chat">
      <h2>Chat:</h2>
      <ul id="messages">
      </ul>
      <input type="text" id="message">
      <input type="button" value="Save" onclick="send()">
    </div>
  </form>
  <script type="text/javascript">
    var socket;
    var token;

    function validate(server, token, exchangeMatchId) {
      if (!server) {
        return alert('required Server');
      }
      if (!token) {
        return alert('required User ID');
      }
      if (!exchangeMatchId) {
        return alert('required Exchange Match ID');
      }
    }

    function addMessage(user, msg) {
      var nick = user.firstName;
      if(!nick) {
        nick = 'yo';
      }
      var ul = document.getElementById("messages");
      var li = document.createElement("li");
      li.textContent = nick + ': ' + msg;
      ul.appendChild(li);
    }

    function connect() {
      var server = document.getElementById("server").value;
      socket = io.connect(server);
    }

    function setup() {
      var server = document.getElementById("server").value;
      token = document.getElementById("token").value;
      var exchangeMatchId = document.getElementById("exchangeMatchId").value;
      validate(server, token, exchangeMatchId);      
      socket.emit('join/chat', {
        room: exchangeMatchId,
        token: token
      });
      socket.on('join/chat:done', () => {
        document.getElementById('chat').style.display = 'block';
      });
      socket.on('message', function (msg) {
        addMessage(msg.user, msg.message.value);
      });
      socket.on('chat/error', function (err) {
        return alert('[error] ' + err);
      });
      socket.on('leave/chat:done', () => {
        // document.getElementById('chat').style.display = 'none';
      });
    }

    function send() {
      var msg = document.getElementById('message').value;
      var message = {
        value: msg,
        type: 'text'
      }
      socket.emit('message/chat', message);
      addMessage({firstName: 'yo'}, msg)
      document.getElementById('message').value = "";
    }

    function disconnect() {
      socket.disconnect();
      document.getElementById('chat').style.display = 'none';
    }

    function leave() {
      socket.emit('leave/chat', {});
    }

    document.getElementById('chat').style.display = 'none';
  </script>
</body>

</html>